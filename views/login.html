<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html,body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .login-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 400px;
        }
        .admin-container {
            height: 100vh;
            display: flex;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .sidebar {
            background: linear-gradient(180deg, #2c3e50, #1a2533);
            border-radius: 16px 0 0 16px;
        }
        .nav-item {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .nav-item.active {
            background-color: rgba(255,255,255,0.15);
            border-left: 4px solid #3498db;
        }
        .description-cell {
            max-width: 300px;
            white-space: normal;
        }
        .flex-1 {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #products-view {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #products-view > .bg-white.border {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #products-view .overflow-y-auto {
            flex: 1;
            min-height: 0;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gray-100 p-4">
        <!-- Login Screen -->
        <div id="login-screen" class="flex items-center justify-center min-h-screen">
            <div class="login-container w-full p-8">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold mb-2">Product Admin</h1>
                    <p class="text-gray-600">Enter your password to access the admin panel</p>
                </div>
                
                <div id="login-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden">
                    Incorrect password. Please try again.
                </div>
                
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter admin password">
                </div>
                
                <button id="login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition-colors">
                    Login
                </button>
                
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div id="admin-panel" class="hidden">
            <div class="admin-container w-full max-w-screen-2xl mx-auto flex flex-col md:flex-row overflow-hidden">

                <!-- Sidebar Navigation -->
                <div class="sidebar w-full md:w-64 bg-gray-800 text-white p-4 md:p-6">
                    <div class="flex items-center justify-between md:justify-start mb-8">
                        <h1 class="text-2xl font-bold">Admin Panel</h1>
                        <button id="mobile-menu-toggle" class="md:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="nav-items">
                        <div class="mb-6">
                            <div class="text-sm text-gray-400 mb-2">MANAGEMENT</div>
                            <div id="nav-products" class="nav-item active flex items-center p-3 rounded cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                </svg>
                                <span>Products</span>
                            </div>
                            <div id="nav-categories" class="nav-item flex items-center p-3 rounded cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                </svg>
                                <span>Categories</span>
                            </div>
                            <div id="nav-customer" class="nav-item flex items-center p-3 rounded cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <span>Customer</span>
                            </div>
                            <div id="nav-quotation" class="nav-item flex items-center p-3 rounded cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span>Quotation</span>
                            </div>
                            <div id="nav-upload-excel" class="nav-item flex items-center p-3 rounded cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v16h16V4H4zm4 4h8v2H8V8zm0 4h6v2H8v-2z" />
                                </svg>
                                <span>Upload Excel</span>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <div class="text-sm text-gray-400 mb-2">ACCOUNT</div>
                            <div id="logout-btn" class="nav-item flex items-center p-3 rounded cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                <span>Logout</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content Area -->
                <div class="flex-1 bg-white p-4 md:p-8 overflow-y-auto">
                    <!-- Products View -->
                    <div id="products-view">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <h2 class="text-2xl font-bold mb-4 md:mb-0">Products</h2>
                            <div class="w-full md:w-auto flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                                <div class="relative flex-1 md:w-64">
                                    <input id="product-search" type="text" placeholder="Search products..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="">All Categories</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="clothing">Clothing</option>
                                </select>
                                <button id="add-product-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add Product
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="flex-1 overflow-y-auto border border-gray-300 rounded">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub Category</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Products will be dynamically inserted here -->
                                    </tbody>
                                </table>
                                <div id="pagination-controls" class="flex justify-between items-center mt-4">
                                    <button id="prev-page" class="px-3 py-1 border rounded">Previous</button>
                                    <div id="page-info" class="text-sm"></div>
                                    <button id="next-page" class="px-3 py-1 border rounded">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categories View -->
                    <div id="categories-view" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <h2 class="text-2xl font-bold mb-4 md:mb-0">Categories</h2>
                            <div class="w-full md:w-auto flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                                <div class="relative flex-1 md:w-64">
                                    <input id="category-search" type="text" placeholder="Search categories..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <button id="add-category-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add Category
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="categories-grid">
                            <!-- Categories will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- Customer Info View -->
                    <div id="customer-view" class="hidden">
                        <h2 class="text-2xl font-bold mb-6">Customer Information</h2>
                        <div class="bg-white rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quotation No.</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="quotation-auto" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Auto-generate on click" readonly>
                                        <button type="button" onclick="generateQuotationNo()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Add</button>
                                    </div>
                                </div>
                                <!-- New: Real-time company filter -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">üîé Filter Company</label>
                                    <input type="text" id="company-filter" placeholder="Search company..." class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                                </div>
                                <!-- Customer Info -->
                                <div class="md:col-span-2 grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                        <input type="text" id="customer-company" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter company name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name *</label>
                                        <input type="text" id="customer-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter customer name">
                                    </div>
                                    <div>
                                        <label for="contact-dropdown" class="text-sm font-medium text-gray-700 mb-1">Contact Person (Customer)</label>
                                        <select id="contact-dropdown" class="border px-2 py-1 rounded w-full mb-2" style="display: none;">
                                        <option value="">-- Select Contact --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input type="tel" id="customer-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter phone number">
                                    </div>
                                    <div class="md:col-start-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                        <input type="email" id="customer-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter email address">
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Customer Ref.</label>
                                    <input type="text" id="customer-ref" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. CMO Deflector cone for AD 14&quot;">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Enquiry Ref.</label>
                                    <input type="text" id="enquiry-ref" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. TK2408-0021">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                    <textarea id="customer-address" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter address"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea id="customer-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter any additional notes"></textarea>
                                </div>

                                <div class="md:col-span-2">
                                    <h5 class="text-md font-semibold text-blue-600 mt-4 mb-2">Sales Information</h5>
                                </div>

                                <!-- Sales Info -->
                                <div class="md:col-span-2 grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">üîé Filter Sales Person</label>
                                    <input id="sales-filter" type="text" placeholder="Type to search..." class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">üîé Filter Contact Person</label>
                                    <input id="contact-filter" type="text" placeholder="Type to search..." class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
                                </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Sales Person</label>
                                    <input type="text" id="sales-person" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter sales person name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                                    <input type="text" id="sales-contact" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact person">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Sales Mobile</label>
                                    <input type="text" id="sales-mobile" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter sale mobile number">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Tel</label>
                                    <input type="text" id="contact-tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact tel">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Sales Email</label>
                                    <input type="email" id="sales-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter sales email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                                    <input type="email" id="contact-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact email">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Time</label>
                                    <input type="text" id="delivery-time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. 4-5 WORKING WEEKS AFTER RECEIVED ACKNOWLEDGEMENT">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Term</label>
                                    <input type="text" id="delivery-term" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. DDP AT SITE, Rayong Thailand">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Term</label>
                                    <input type="text" id="payment-term" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. CREDIT 30 DAYS">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quotation Validity</label>
                                    <input type="text" id="quotation-validity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. 7 DAYS">
                                </div>
                            </div>

                            <div class="mt-8 flex justify-between">
                                <button id="generate-quotation-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Generate Quotation
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quotation View -->
                    <div id="quotation-view" class="hidden">
                            <div class="mb-4 flex flex-wrap items-center justify-between gap-4">
                                <!-- ‚úÖ ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: Upload Drawing -->
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-sm font-medium text-gray-700 whitespace-nowrap">
                                    Upload PDF Drawing
                                    </span>

                                    <!-- ‚úÖ input + button ‡∏ä‡∏¥‡∏î‡∏Å‡∏±‡∏ô -->
                                    <div class="flex items-center gap-1">
                                    <input type="file" id="drawingPdfInput" accept=".pdf" multiple class="text-sm" />
                                    <button id="uploadPdfBtn"
                                        class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                                        Upload
                                    </button>
                                    </div>
                                </div>

                                <!-- ‚úÖ ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: Filters -->
                                <div class="flex items-center gap-2 flex-wrap justify-end mb-2">
                                    <select id="quotation-status-filter" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">-- All Status --</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approve">Approve</option>
                                    <option value="Disapprove">Disapprove</option>
                                    </select>

                                    <select id="quotation-no-select" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ --</option>
                                    </select>

                                    <select id="quotation-rev-select" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">-- Revision --</option>
                                    </select>

                                    <button onclick="fetchQuotation()"
                                    class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 transition text-sm">
                                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                    </button>
                                </div>
                            </div>
                        
                        <div class="quotation p-8 rounded-lg">
                            <!-- Header logo and company name -->
                            <div id="quotation-print-area">
                            <div class="quotation-body">
                            <div class="mb-4">
                                <div class="flex justify-between items-center">
                                    <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó -->
                                    <div class="flex items-center gap-4">
                                    <img src="/images/m-wave.jpg" alt="M-Wave Logo" class="h-10 w-10 object-contain" />
                                    <h1 class="text-2xl font-semibold">Mwave</h1>
                                    </div>
                                </div>

                                <!-- ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏µ‡∏î -->
                                <hr class="my-3 border-t border-gray-400 w-[1100px] mx-auto" />
                            </div>
                            
                            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: Quotation + ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
                            <div class="flex justify-between items-start mb-6">
                                <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó -->
                                <div class="text-sm leading-6">
                                    <h2 class="text-lg font-bold mb-1">Quotation</h2>
                                    <p class="text-sm font-semibold" id="quote-customer-company"></p>
                                    <p class="text-sm pt-3"id="quote-customer-address"></p>
                                </div>

                                <!-- ‡∏Ç‡∏ß‡∏≤: Page + Quotation No. -->
                                <!-- Container ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á -->
                                <div class="text-sm flex flex-col items-center space-y-2">
                                <p class="text-center"><strong>Page :</strong> 1 of 1</p>
                                <p class="text-center">For further inquiries, please specify :</p>

                                <div class="w-[300px] bg-blue-100 rounded-lg p-4 border border-blue-500 inline-block shadow-sm text-left">
                                    <p class="font-bold">
                                    <span>Quotation No.:</span>
                                    <span class="ml-2 font-normal" id="quote-no">QT2408-0076 Rev. 1</span>
                                    </p>
                                    <p class="font-bold">
                                    <span>Issued Date :</span>
                                    <span class="ml-2 font-normal" id="quote-date">27/02/25</span>
                                    </p>
                                </div>
                                </div>
                            </div>

                            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 text-xs leading-5 mb-2">
                            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
                            <div class="md:col-span-2">
                                <p><strong>Attn :</strong> <span id="quote-customer-name">K.Napakorn Klaimee</span></p>
                                <p><strong>Tel :</strong> <span id="quote-customer-phone">038-974-173 064-569-7779</span></p>
                                <p><strong>Email :</strong> <span id="quote-customer-email">napakorn.k@wha-gc.com</span></p>
                                <p><strong>Customer Ref. :</strong> <span id="quote-customer-ref"></span></p>
                                <p><strong>Enquiry Ref. :</strong> <span id="quote-enquiry-ref"></span></p>
                                <p style="font-size: 10px; line-height: 1.7;">
                                With reference to your enquiry, we are pleased to offer as below for your consideration
                                </p>
                            </div>

                            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ -->
                            <div class="md:col-span-1 md:justify-self-start">
                                <p><strong>Sales Person :</strong> <span id="quote-sales-person"></span></p>
                                <p><strong>Mobile :</strong> <span id="quote-sales-mobile"></span></p>
                                <p><strong>E-Mail :</strong> <span id="quote-sales-email"></span></p>
                                <p><strong>Contact :</strong> <span id="quote-sales-contact"></span></p>
                                <p><strong>Tel :</strong> <span id="quote-contact-tel"></span></p>
                                <p><strong>E-Mail :</strong> <span id="quote-contact-email"></span></p>
                            </div>
                            </div>


                            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                            <table class="w-full border-collapse text-xs mt-4">
                                <thead class="bg-gray-100">
                                    <tr>
                                    <th class="border-b border-black px-2 py-1 align-top">Item</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Model</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Description</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Qty.</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Unit</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Unit Price</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Amount</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Unit Cost</th>
                                    <th class="border-b border-black px-2 py-1 align-top">Margin Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="quote-items">
                                    <!-- ‡πÅ‡∏ñ‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                                </tbody>
                            </table>
                            </div>
                            <br/>
                            <br/>
                            <br/>

                            <div class="quotation-footer">
                            <!-- ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏µ‡∏î‡∏ö‡∏ô -->
                            <hr class="pb-1 border-t border-t-[0.2px] border-gray-500  mx-auto" />

                            <!-- ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç -->
                            <div class="text-xs space-y-1">
                            <p><strong>Delivery Time :</strong> <span id="quote-delivery-time"></span></p>
                            <p><strong>Delivery Term :</strong> <span id="quote-delivery-term"></span></p>
                            <p><strong>Payment Term :</strong> <span id="quote-payment-term"></span></p>
                            <p><strong>Quotation Validity :</strong> <span id="quote-quotation-validity"></span></p>
                            </div>

                            <!-- ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏µ‡∏î‡∏•‡πà‡∏≤‡∏á -->
                            <hr class="border-t border-black my-1" />

                            <!-- ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏¢ + ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ -->
                            <div class="flex justify-between items-start text-xs mt-1 gap-4">
                            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏° -->
                            <div class="flex flex-col justify-start max-w-[65%]">
                                <p id="quote-total-words" class="italic text-xs">
                                <!-- ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
                                </p>
                                <p class="mt-10"> 
                                Kindly go through the quotation and we look forward to your favorable reply.
                                </p>
                            </div>

                            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ -->
                            <div class="space-y-1 text-right min-w-[220px] text-xs">
                                <!-- Subtotal  ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô vat-->
                                <div class="pb-2 flex justify-between">
                                    <span class="font-semibold">Total</span>
                                    <span id="quote-subtotal" class="ml-2">0.00</span>
                                </div>

                                <!-- VAT 7%-->
                                <div class="pb-2 flex justify-between">
                                    <span class="font-semibold">VAT (7%)</span>
                                    <span id="quote-tax" class="ml-2">0.00</span>
                                </div>

                                <!-- Subtotal  ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏á vat-->
                                <div class="pb-2 flex justify-between">
                                    <span class="font-semibold">Total Amount</span>
                                    <span id="quote-total" class="ml-2">0.00</span>
                                </div>

                                <!-- Margin ‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°-->
                                <div class="pb-2 flex justify-between">
                                    <span class="font-semibold">Total Margin Amount</span>
                                    <span id="quote-margin" class="ml-2">0.00</span>
                                </div>
                            </div>
                            </div>

                            <p class="mt-4 font-bold text-xs">Best Regards,</p>

                            <!-- ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ -->
                            <div class="my-2 flex justify-end text-xs">
                            <div class="text-center">
                                <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
                                <p class="font-bold">DUSADEE.MWAVE</p>

                                <!-- ‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡∏ä‡∏∑‡πà‡∏≠ -->
                                <div class="w-[160px] h-[1px] bg-black my-1 mx-auto"></div>

                                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
                                <p class="font-semibold">Authorized Signature</p>
                                <p class="mt-1">Date : <strong id="signature-date">27/02/25</strong></p>
                            </div>
                            </div>

                            <!-- ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
                            <hr class="my-6 border-t border-gray-300" />

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs text-gray-800">
                            <!-- Nonthaburi Office -->
                            <div class="flex items-start gap-2">
                                <img src="/images/location-logo.jpg" alt="Location Icon" class="h-4 w-4 mt-0.5 object-contain" />
                                <div>
                                <p><strong>Nonthaburi (Head) Office:</strong> 73/4</p>
                                <p>Moo. 1 Bangkruay-Sainoi Rd.,</p>
                                <p style="white-space: nowrap;">Banglane, Bangyai, Nonthaburi 11140</p>
                                <p>Phone : +66 2147 4747</p>
                                <p>Fax : +66 2921 5402</p>
                                </div>
                            </div>

                            <!-- Rayong Office -->
                            <div class="flex items-start gap-2 md:justify-self-center">
                                <img src="/images/location-logo.jpg" alt="Location Icon" class="h-4 w-4 mt-0.5 object-contain" />
                                <div>
                                <p><strong>Rayong Office:</strong> 49/19</p>
                                <p>Sukhumvit Rd., Nern-Pra,</p>
                                <p>Muang, Rayong 21150</p>
                                <p>Phone : +66 3894 7271</p>
                                <p>Fax : +66 3894 7275</p>
                                </div>
                            </div>

                            <!-- Website + Email -->
                            <div class="flex items-start gap-2">
                                <img src="/images/world_icon.png" alt="Globe Icon" class="h-4 w-4 mt-0.5 object-contain" />
                                <div>
                                <p><strong>URL:</strong> www.mwavegroup.com</p>
                                <p><strong>Email:</strong> sales@mwavegroup.com</p>
                                </div>
                            </div>
                            </div>
                            </div>

                            </div>
                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
                            <div class="mt-6 flex justify-end gap-4">
                            <button id="approve-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button id="disapprove-btn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                                Disapprove
                            </button>
                            <button id="edit-quote" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Edit Quote
                            </button>
                            </div>
                        </div>
                    </div>

                    <div id="upload-excel-view" class="hidden">
                        <h2 class="text-xl font-bold mb-4">Upload Excel (.xlsx)</h2>
                        <div class="mb-4">
                            <input type="file" id="excel-upload" accept=".xlsx" class="text-sm"/>
                        </div>
                        <button id="upload-excel-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            Upload
                        </button>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- Add/Edit Product Modal -->
        <div id="product-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="absolute inset-0 bg-black opacity-50"></div>
            <div class="relative bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <button id="close-product-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h3 id="product-modal-title" class="text-xl font-bold mb-4">Add New Product</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="product-id" class="block text-sm font-medium text-gray-700 mb-1">Product ID</label>
                        <input type="text" id="product-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., p1, e2, etc.">
                    </div>
                    
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="product-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter product name">
                    </div>
                    
                    <div>
                        <label for="product-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="product-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ú‡πà‡∏≤‡∏ô JavaScript -->
                        </select>
                    </div>

                    <div>
                        <label for="product-sub-category" class="block text-sm font-medium text-gray-700 mb-1">Sub Category</label>
                        <input type="text" id="product-sub-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter sub category">
                    </div>

                    <div>
                        <label for="product-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="product-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter product description"></textarea>
                    </div>
                    
                    <div>
                        <label for="product-cost" class="block text-sm font-medium text-gray-700 mb-1">Cost (‡∏ø)</label>
                        <input type="number" id="product-cost" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter cost">
                    </div>

                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Price (‡∏ø)</label>
                        <input type="number" id="product-price" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter price">
                    </div>

                    <div>
                        <label for="product-image" class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
                        <img id="image-preview" class="h-20 w-20 object-cover rounded mb-2 hidden">
                        <input type="file" id="product-image" name="product-image">
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button id="cancel-product" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button id="save-product" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            Save Product
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Category Modal -->
        <div id="category-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="absolute inset-0 bg-black opacity-50"></div>
            <div class="relative bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <button id="close-category-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h3 id="category-modal-title" class="text-xl font-bold mb-4">Add New Category</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="category-id" class="block text-sm font-medium text-gray-700 mb-1">Category ID</label>
                        <input type="text" id="category-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., electronics, furniture, etc.">
                    </div>
                    
                    <div>
                        <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                        <input type="text" id="category-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter category name">
                    </div>
                    
                    <div>
                        <label for="category-icon" class="block text-sm font-medium text-gray-700 mb-1">Icon (Emoji)</label>
                        <!-- Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á emoji ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                        <input type="text" id="category-icon" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Click to select emoji" readonly>

                        <!-- Emoji Picker popup -->
                        <div id="emoji-popup" class="hidden absolute z-50 bg-white p-2 border border-gray-300 rounded shadow-lg mt-2">
                        <emoji-picker id="emoji-picker"></emoji-picker>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button id="cancel-category" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button id="save-category" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            Save Category
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="absolute inset-0 bg-black opacity-50"></div>
            <div class="relative bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                
                <p id="delete-message" class="mb-6">Are you sure you want to delete this item? This action cannot be undone.</p>
                
                <div class="flex justify-end space-x-4">
                    <button id="cancel-delete" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('login-btn');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        
        const navProducts = document.getElementById('nav-products');
        const navCategories = document.getElementById('nav-categories');
        const logoutBtn = document.getElementById('logout-btn');
        
        const productsView = document.getElementById('products-view');
        const categoriesView = document.getElementById('categories-view');
        const navCustomer = document.getElementById('nav-customer');
        const navQuotation = document.getElementById('nav-quotation');
        const customerView = document.getElementById('customer-view');
        const quotationView = document.getElementById('quotation-view');

        const productSearch = document.getElementById('product-search');
        const categoryFilter = document.getElementById('category-filter');
        const addProductBtn = document.getElementById('add-product-btn');
        
        const categorySearch = document.getElementById('category-search');
        const addCategoryBtn = document.getElementById('add-category-btn');
        
        const productModal = document.getElementById('product-modal');
        const closeProductModal = document.getElementById('close-product-modal');
        const productModalTitle = document.getElementById('product-modal-title');
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productCategorySelect = document.getElementById('product-category');
        const productDescriptionInput = document.getElementById('product-description');
        const productPriceInput = document.getElementById('product-price');
        const cancelProductBtn = document.getElementById('cancel-product');
        const saveProductBtn = document.getElementById('save-product');
        
        const categoryModal = document.getElementById('category-modal');
        const closeCategoryModal = document.getElementById('close-category-modal');
        const categoryModalTitle = document.getElementById('category-modal-title');
        const categoryIdInput = document.getElementById('category-id');
        const categoryNameInput = document.getElementById('category-name');
        const categoryIconInput = document.getElementById('category-icon');
        const emojiPopup = document.getElementById('emoji-popup');
        const emojiPicker = document.getElementById('emoji-picker');
        const cancelCategoryBtn = document.getElementById('cancel-category');
        const saveCategoryBtn = document.getElementById('save-category');
        
        const deleteModal = document.getElementById('delete-modal');
        const deleteMessage = document.getElementById('delete-message');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        
        // Toggle popup on input click
        categoryIconInput.addEventListener('click', () => {
            emojiPopup.classList.toggle('hidden');
        });

        // Set emoji to input and hide popup
        emojiPicker.addEventListener('emoji-click', event => {
            categoryIconInput.value = event.detail.unicode;
            emojiPopup.classList.add('hidden');
        });

        // State variables
        let editingProductId = null;
        let editingCategoryId = null;
        let deleteItemType = null;
        let deleteItemId = null;
        let productCounts = {};
        let products = [];
        let totalPages = 1;
        let drawingSelections = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å DWG ‡∏ï‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤

        // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤ fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ array ‡∏à‡∏£‡∏¥‡∏á
        if (!Array.isArray(products)) products = [];

        const navItems = document.querySelectorAll('.nav-item');
        const views = ['products', 'categories', 'customer', 'quotation', 'upload-excel'];

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const id = item.id.replace('nav-', '');
                // Toggle active sidebar
                navItems.forEach(el => el.classList.remove('active'));
                item.classList.add('active');

                // Hide all views
                views.forEach(view => {
                const el = document.getElementById(`${view}-view`);
                if (el) el.classList.add('hidden');
                });

                // Show selected view
                const target = document.getElementById(`${id}-view`);
                if (target) target.classList.remove('hidden');
            });
        });

        // Initialize the application
        async function init() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');  

            if (isLoggedIn === 'true') {
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                showView('products');

                await loadAdminData(); 

                try {
                    // üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏≤‡∏Å Google Sheets (‡∏ú‡πà‡∏≤‡∏ô FastAPI)
                    const resCat = await fetch("/categories");
                    categories = await resCat.json();

                    // üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ 1)
                    currentPage = 1;
                    await loadProductPage(currentPage);

                    // üîπ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ UI
                    renderCategories();
                    updateProductCategorySelect();
                    updateCategoryFilter();
                } catch (err) {
                    console.error("‚ùå Failed to load data from server:", err);
                    alert("Unable to load product/category data from Google Sheets.");
                }
            } else {
                loginScreen.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }

            // üîê Login event
            loginBtn.addEventListener('click', login);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });

            // üîÄ Navigation
            navProducts.addEventListener('click', () => showView('products'));
            navCategories.addEventListener('click', () => showView('categories'));
            navCustomer.addEventListener('click', () => showView('customer'));
            navQuotation.addEventListener('click', () => showView('quotation'));
            logoutBtn.addEventListener('click', logout);

            // üì¶ Product events
            productSearch.addEventListener('input', filterProducts);
            categoryFilter.addEventListener('change', () => {
                currentPage = 1;
                loadProductPage(currentPage);
            });
            addProductBtn.addEventListener('click', () => openAddProductModal());
            closeProductModal.addEventListener('click', () => closeModal(productModal));
            cancelProductBtn.addEventListener('click', () => closeModal(productModal));
            saveProductBtn.addEventListener('click', saveProduct);

            // üóÇÔ∏è Category events
            categorySearch.addEventListener('input', filterCategories);
            addCategoryBtn.addEventListener('click', () => openAddCategoryModal());
            closeCategoryModal.addEventListener('click', () => closeModal(categoryModal));
            cancelCategoryBtn.addEventListener('click', () => closeModal(categoryModal));
            saveCategoryBtn.addEventListener('click', saveCategory);

            // üóëÔ∏è Delete modal
            cancelDeleteBtn.addEventListener('click', () => closeModal(deleteModal));
            confirmDeleteBtn.addEventListener('click', confirmDelete);

            await loadQuotationDropdown(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î dropdown
            document.getElementById('quotation-status-filter')?.addEventListener('change', loadQuotationDropdown);
            document.getElementById('generate-quotation-btn')?.addEventListener('click', generateAndSendQuotation);

            // üü£ Pagination controls
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadProductPage(currentPage);
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                currentPage++;
                loadProductPage(currentPage);
            });

            document.getElementById('quotation-no-select')?.addEventListener('change', async () => {
                const quotationNo = document.getElementById('quotation-no-select').value;
                const revSelect = document.getElementById('quotation-rev-select');

                if (!quotationNo) {
                    revSelect.innerHTML = '<option value="">-- Revision --</option>';
                    return;
                }

                try {
                    const res = await fetch(`/revisions/${quotationNo}`);
                    const revisions = await res.json();

                    revSelect.innerHTML = '<option value="">-- Revision --</option>';
                    revisions.forEach(rev => {
                        const opt = document.createElement('option');
                        opt.value = rev;
                        opt.textContent = `Rev. ${rev}`;
                        revSelect.appendChild(opt);
                    });
                } catch (err) {
                    console.error('‚ùå Failed to load revisions:', err);
                    revSelect.innerHTML = '<option value="">-- Revision --</option>';
                }
            });

            // Filter company input
            document.getElementById('company-filter')?.addEventListener('input', async e => {
                const filter = e.target.value.trim();
                if (!filter) return;

                try {
                    const res = await fetch(`/company_lookup?query=${encodeURIComponent(filter)}`);
                    if (!res.ok) throw new Error("Not found");

                    const result = await res.json();

                    document.getElementById('customer-company').value = result.company || '';
                    document.getElementById('customer-address').value = result.address || '';

                    // ‚úÖ handle dropdown
                    const contactDropdown = document.getElementById('contact-dropdown');
                    if (!contactDropdown) return;

                    const hasContacts = Array.isArray(result.contacts) && result.contacts.length > 0;

                    if (hasContacts) {
                    contactDropdown.innerHTML = '<option value="">-- Select Contact --</option>';
                    result.contacts.forEach((c, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        opt.textContent = `${c.name} (${c.email})`;
                        contactDropdown.appendChild(opt);
                    });

                    contactDropdown.style.display = ''; // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á dropdown
                    } else {
                    contactDropdown.innerHTML = '';      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
                    contactDropdown.style.display = 'none'; // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô dropdown
                    }

                    contactDropdown.onchange = function () {
                    const selected = result.contacts[this.value];
                    if (selected) {
                        document.getElementById('customer-name').value = selected.name || '';
                        document.getElementById('customer-phone').value = selected.phone || '';
                        document.getElementById('customer-email').value = selected.email || '';
                    }
                    };

                } catch (err) {
                    console.warn('‚ùå Company lookup failed:', err);
                }
            });

            // filter sale input 
            document.getElementById('sales-filter')?.addEventListener('input', async e => {
                const code = e.target.value.trim();
                if (!code) return;

                try {
                    const res = await fetch(`/sales_lookup_by_code?code=${encodeURIComponent(code)}`);
                    if (!res.ok) throw new Error('Not found');

                    const result = await res.json();

                    document.getElementById('sales-person').value = result.salesPerson || '';
                    document.getElementById('sales-mobile').value = result.salesMobile || '';
                } catch (err) {
                    console.warn('‚ùå Sales code lookup failed:', err);
                }
            });

            // filter contact input
            document.getElementById('contact-filter')?.addEventListener('input', async e => {
                const code = e.target.value.trim();
                if (!code) return;

                try {
                    const res = await fetch(`/contact_lookup_by_code?code=${encodeURIComponent(code)}`);
                    if (!res.ok) throw new Error('Not found');

                    const result = await res.json();

                    document.getElementById('sales-contact').value = result.contactPerson || '';
                    document.getElementById('contact-tel').value = result.contactTel || '';
                } catch (err) {
                    console.warn('‚ùå Contact code lookup failed:', err);
                }
            });

        }

        // ‚úÖ Login function
        function login() {
            const password = passwordInput.value;

            if (password === 'admin123') {
                localStorage.setItem('isLoggedIn', 'true');  // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage

                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                showView('products');

                loadAdminData();
            } else {
                loginError.classList.remove('hidden');
                setTimeout(() => loginError.classList.add('hidden'), 3000);
            }
        }

        // ‚úÖ ‡πÅ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• admin ‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
        async function loadAdminData() {
            try {
                const [resCat, resProd, resCounts] = await Promise.all([
                    fetch("/categories"),
                    fetch("/basic_products?page=1&size=50"),
                    fetch("/product_counts_by_category")
                ]);

                categories = await resCat.json();
                const data = await resProd.json();
                products = data.items;
                totalProducts = data.total;
                productCounts = await resCounts.json();  // ‡πÄ‡∏Å‡πá‡∏ö product count per category

                renderCategories();
                renderProducts();
                updateCategoryFilter();
                updateProductCategorySelect();
            } catch (err) {
                console.error("‚ùå Failed to load data:", err);
                alert("Error loading data from server.");
            }
        }

        // ‚úÖ Logout function
        function logout() {
            localStorage.removeItem('isLoggedIn');  // ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            window.location.href = "/";             // ‚úÖ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ index.ejs
        }

        // Show view function
        function showView(view) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å view
            productsView.classList.add('hidden');
            categoriesView.classList.add('hidden');
            customerView.classList.add('hidden');
            quotationView.classList.add('hidden');

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            if (view === 'products') {
                productsView.classList.remove('hidden');
                navProducts.classList.add('active');
            } else if (view === 'categories') {
                categoriesView.classList.remove('hidden');
                navCategories.classList.add('active');
            } else if (view === 'customer') {
                customerView.classList.remove('hidden');
                navCustomer.classList.add('active');
            } else if (view === 'quotation') {
                quotationView.classList.remove('hidden');
                navQuotation.classList.add('active');
            }
        }
        
        // Render products table
        function renderProducts() {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = '';

            // üîç Filter ‡∏à‡∏≤‡∏Å search input (‡πÉ‡∏ô page data ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            let filteredProducts = Array.isArray(products) ? products : [];
            const searchValue = productSearch.value.toLowerCase();
            if (searchValue) {
                filteredProducts = filteredProducts.filter(product =>
                    product.name?.toLowerCase().includes(searchValue) ||
                    product.product_id?.toLowerCase().includes(searchValue) ||
                    (product.description || '').toLowerCase().includes(searchValue)
                );
            }

            // üîç Filter ‡∏à‡∏≤‡∏Å category dropdown (‡πÉ‡∏ô page data ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            const categoryValue = categoryFilter.value;
            if (categoryValue) {
                filteredProducts = filteredProducts.filter(product => product.category === categoryValue);
            }

            // üï≥Ô∏è ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á
            if (filteredProducts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No products found
                        </td>
                    </tr>
                `;
                return;
            }

            // üîÅ ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            filteredProducts.forEach(product => {
                const category = categories.find(c => c.category_id === product.category);
                const categoryName = category?.name || product.category;
                const price = parseFloat(product.price);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö image_url
                let imageUrl = product.image_url || product.image || '';
                if (imageUrl && imageUrl.startsWith('/')) {
                    imageUrl = `http://localhost:3000${imageUrl}`;
                }
                if (!imageUrl) {
                    imageUrl = '/images/m-wave.jpg';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-mono">${product.product_id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="${imageUrl}" alt="Image of ${product.name}" class="h-10 w-10 object-cover rounded">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium">${product.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">${categoryName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">${product.sub_category || ''}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm description-cell">${product.description || 'No description available'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-blue-700">‡∏ø${Number(product.cost || 0).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium">${
                            product.price == null ? '-' : `‡∏ø${price.toFixed(2)}`
                        }</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button class="edit-product text-blue-500 hover:text-blue-700 mr-3" data-id="${product.product_id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button class="delete-product text-red-500 hover:text-red-700" data-id="${product.product_id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // ‚úèÔ∏è Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Edit/Delete
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    openEditProductModal(id);
                });
            });

            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    openDeleteModal('product', id);
                });
            });
        }

        // Filter products
        function filterProducts() {
            renderProducts();
        }
        
        // Render categories
        function renderCategories() {
            const categoriesGrid = document.getElementById('categories-grid');
            categoriesGrid.innerHTML = '';

            let filteredCategories = categories;

            // üîé Apply search filter
            const searchValue = categorySearch.value.toLowerCase();
            if (searchValue) {
                filteredCategories = filteredCategories.filter(category =>
                    category.name.toLowerCase().includes(searchValue) ||
                    category.category_id.toLowerCase().includes(searchValue)
                );
            }

            // üñºÔ∏è Render each category card
            filteredCategories.forEach(category => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow';
                categoryCard.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="text-4xl">${category.icon}</div>
                            <div class="flex">
                                <button class="edit-category text-blue-500 hover:text-blue-700 mr-2" data-id="${category.category_id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button class="delete-category text-red-500 hover:text-red-700" data-id="${category.category_id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <h3 class="font-medium text-lg mb-2">${category.name}</h3>
                        <div class="text-sm text-gray-500">
                            ${productCounts[category.name] || 0} products
                        </div>
                    </div>
                `;

                categoriesGrid.appendChild(categoryCard);
            });

            // üîÅ Add event listeners
            document.querySelectorAll('.edit-category').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    openEditCategoryModal(id);
                });
            });

            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    openDeleteModal('category', id);
                });
            });

            // ‚ùó ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ category ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á
            if (filteredCategories.length === 0) {
                categoriesGrid.innerHTML = `
                    <div class="col-span-full py-8 text-center text-gray-500">
                        No categories found
                    </div>
                `;
            }
        }
        
        // Filter categories
        function filterCategories() {
            renderCategories();
        }
        
        // Open add product modal
        function openAddProductModal() {
            productModalTitle.textContent = 'Add New Product';

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            productIdInput.value = '';
            productNameInput.value = '';
            document.getElementById('product-sub-category').value = '';
            productDescriptionInput.value = '';
            document.getElementById('product-cost').value = '';
            productPriceInput.value = '';
            document.getElementById('product-image').value = '';

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå image preview
            const imagePreview = document.getElementById('image-preview');
            imagePreview.src = '';
            imagePreview.classList.add('hidden');

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï dropdown category ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            updateProductCategorySelect(categories[0]?.name || '');

            editingProductId = null;
            editingImageUrl = null;

            productModal.classList.remove('hidden');
        }
        
        // Open edit product modal
        let editingImageUrl = null;  // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö image_url ‡πÄ‡∏î‡∏¥‡∏°

        function openEditProductModal(id) {
            const product = Array.isArray(products) ? products.find(p => p.product_id === id) : null;

            if (!product) {
                alert("Product not found");
                return;
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ title modal
            productModalTitle.textContent = 'Edit Product';

            // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏á field
            productIdInput.value = product.product_id;
            productNameInput.value = product.name || '';
            document.getElementById('product-sub-category').value = product.sub_category || '';
            productDescriptionInput.value = product.description || '';
            productPriceInput.value = product.price != null ? product.price : '';
            document.getElementById('product-cost').value = product.cost != null ? product.cost : '';

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ category
            updateProductCategorySelect(product.category);

            editingImageUrl = product.image || null;  // ‚≠ê ‡πÉ‡∏ä‡πâ field image (‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å Google Sheets)

            // ‡πÅ‡∏™‡∏î‡∏á preview ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°
            const imagePreview = document.getElementById('image-preview');
            if (editingImageUrl) {
                imagePreview.src = editingImageUrl.startsWith('/')
                    ? `http://localhost:3000${editingImageUrl}`
                    : editingImageUrl;
            } else {
                imagePreview.src = '/images/m-wave.jpg';
            }
            imagePreview.classList.remove('hidden');

            // ‡πÄ‡∏Å‡πá‡∏ö id ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏´‡∏ô
            editingProductId = id;

            // ‡πÄ‡∏õ‡∏¥‡∏î modal
            productModal.classList.remove('hidden');
        }

        // Save product
        async function saveProduct() {
            const id = productIdInput.value.trim();
            const name = productNameInput.value.trim();
            const category = productCategorySelect.value;
            const subCategory = document.getElementById('product-sub-category').value.trim();
            const description = productDescriptionInput.value.trim();
            const rawPrice = productPriceInput.value.trim();
            const price = rawPrice === '' ? null : parseFloat(rawPrice);
            const rawCost = document.getElementById('product-cost').value.trim();
            const cost = rawCost === '' ? null : parseFloat(rawCost);
            const imageInput = document.getElementById('product-image');

            if (!id) {
                alert('Product ID is required.');
                return;
            }

            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Product ID ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
            if (!editingProductId && products.some(p => p.product_id === id)) {
                alert(`Product ID "${id}" is already used. Please use a different ID.`);
                return;
            }

            let imageUrl = editingImageUrl;

            if (imageInput.files.length > 0) {
                const formData = new FormData();
                formData.append('file', imageInput.files[0]);

                try {
                    const res = await fetch('/upload_image', {
                        method: 'POST',
                        body: formData
                    });
                    if (!res.ok) throw new Error("Image upload failed");
                    const data = await res.json();
                    imageUrl = data.url;
                } catch (err) {
                    console.error("‚ùå Image upload failed:", err);
                    alert("Image upload failed");
                    return;
                }
            }

            const payload = {
                product_id: id,
                name: name || "",
                category: category || "",
                sub_category: subCategory || "",
                description: description || "",
                price: price !== null && !isNaN(price) ? price : null,
                cost: cost !== null && !isNaN(cost) ? cost : null  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            };

            // ‡∏™‡πà‡∏á image_url ‡πÄ‡∏™‡∏°‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
            if (imageUrl) {
                payload.image_url = imageUrl;
            }

            const url = editingProductId
                ? `/update_product/${editingProductId}`
                : "/save_basic_product";

            const method = editingProductId ? "PUT" : "POST";

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("Failed to save/update product");
                await res.json();

                alert(editingProductId ? "Product updated successfully!" : "Product added successfully!");

                // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ filter ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‚Äî ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                if (products.length === 0 && currentPage > 1) {
                    currentPage--;
                }

                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° filter ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
                await loadProductPage(currentPage);

                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î productCounts ‡πÉ‡∏´‡∏°‡πà
                const countsRes = await fetch("/product_counts_by_category");
                productCounts = await countsRes.json();

                renderCategories();
                updatePaginationControls();

                closeModal(productModal);
                editingProductId = null;
                editingImageUrl = null;
            } catch (err) {
                console.error("‚ùå Error saving/updating product:", err);
                alert("Failed to save/update product");
            }
        }

        // Open add category modal
        function openAddCategoryModal() {
            categoryModalTitle.textContent = 'Add New Category';
            categoryIdInput.value = '';
            categoryNameInput.value = '';
            categoryIconInput.value = '';

            editingCategoryId = null;

            categoryModal.classList.remove('hidden');
        }

        function openEditCategoryModal(id) {
            const category = categories.find(c => c.category_id === id);

            if (category) {
                categoryModalTitle.textContent = 'Edit Category';
                categoryIdInput.value = category.category_id;
                categoryNameInput.value = category.name;
                categoryIconInput.value = category.icon;

                editingCategoryId = id;

                categoryModal.classList.remove('hidden');
            }
        }
        
        // Save category
        function saveCategory() {
            const id = categoryIdInput.value.trim();
            const name = categoryNameInput.value.trim();
            const icon = categoryIconInput.value.trim();

            if (!id || !name || !icon) {
                alert('Please fill in all fields.');
                return;
            }

            const payload = {
                category_id: id,
                name: name,
                icon: icon
            };

            const url = editingCategoryId
                ? `/update_category/${editingCategoryId}`
                : "/add_category";

            const method = editingCategoryId ? "PUT" : "POST";

            fetch(url, {
                method: method,
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error("Failed to save category");
                return res.json();
            })
            .then(data => {
                console.log("‚úÖ Category saved to Google Sheet:", data);
                alert(editingCategoryId ? "Category updated successfully!" : "Category added successfully!");

                // ‡πÇ‡∏´‡∏•‡∏î categories + productCounts ‡πÉ‡∏´‡∏°‡πà
                return Promise.all([
                    fetch("/categories").then(r => r.json()),
                    fetch("/product_counts_by_category").then(r => r.json())
                ]);
            })
            .then(([cats, counts]) => {
                categories = cats;
                productCounts = counts;
                renderCategories();
                updateCategoryFilter();
                updateProductCategorySelect();
                closeModal(categoryModal);
                editingCategoryId = null;  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ edit ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            })
            .catch(err => {
                console.error("‚ùå Error saving category:", err);
                alert("Failed to save category to Google Sheet");
            });
        }

        // Open delete modal
        function openDeleteModal(type, id) {
            deleteItemType = type;
            deleteItemId = id;

            if (type === 'product') {
                const product = products.find(p => p.product_id === id);
                deleteMessage.textContent = `Are you sure you want to delete the product "${product?.name}"? This action cannot be undone.`;
            } else if (type === 'category') {
                const category = categories.find(c => c.category_id === id);
                const productCount = products.filter(p => p.category === id).length;

                if (productCount > 0) {
                    deleteMessage.textContent = `Warning: This category contains ${productCount} products. Deleting it will also delete all associated products. Are you sure you want to continue?`;
                } else {
                    deleteMessage.textContent = `Are you sure you want to delete the category "${category?.name}"? This action cannot be undone.`;
                }
            }

            deleteModal.classList.remove('hidden');
        }
        
        // Confirm delete
        async function confirmDelete() {
            try {
                if (deleteItemType === 'product') {
                    // üî• ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    const res = await fetch(`/delete_product/${deleteItemId}`, {
                        method: "DELETE"
                    });
                    if (!res.ok) throw new Error("Failed to delete product");
                    await res.json();
                    alert("Product deleted successfully");

                    // üëá ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏Ñ‡πà 1 ‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‚Üí ‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    if (products.length === 1 && currentPage > 1) {
                        currentPage--;
                    }

                    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πâ filter ‡πÄ‡∏î‡∏¥‡∏°
                    await loadProductPage(currentPage);

                    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î productCounts ‡πÉ‡∏´‡∏°‡πà
                    const countsRes = await fetch("/product_counts_by_category");
                    productCounts = await countsRes.json();

                    renderCategories();
                } 
                
                else if (deleteItemType === 'category') {
                    // üî• ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                    const res = await fetch(`/delete_category/${deleteItemId}`, {
                        method: "DELETE"
                    });
                    if (!res.ok) throw new Error("Failed to delete category");
                    await res.json();
                    alert("Category and its products deleted successfully");

                    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• categories + products + productCounts ‡πÉ‡∏´‡∏°‡πà
                    const [catRes, prodRes, countsRes] = await Promise.all([
                        fetch("/categories"),
                        fetch(`/basic_products?page=1&size=${pageSize}`),
                        fetch("/product_counts_by_category")
                    ]);

                    categories = await catRes.json();
                    const prodData = await prodRes.json();
                    products = prodData.items;
                    totalProducts = prodData.total;
                    productCounts = await countsRes.json();

                    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                    currentPage = 1;
                    renderCategories();
                    renderProducts();
                    updateCategoryFilter();
                    updateProductCategorySelect();
                    updatePaginationControls();
                }
            } catch (err) {
                console.error("‚ùå Delete failed:", err);
                alert(`Error deleting ${deleteItemType}`);
            } finally {
                closeModal(deleteModal);
            }
        }

       // ‚úÖ Update category filter dropdown
        function updateCategoryFilter() {
            categoryFilter.innerHTML = '<option value="">All Categories</option>';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name; // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö product.category
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
        }

        // ‚úÖ Close modal
        function closeModal(modal) {
            modal.classList.add('hidden');
        }

        let currentPage = 1;
        let pageSize = 50;
        let totalProducts = 0;

        async function loadProductPage(page = 1) {
            showLoading();
            try {
                let url = `/basic_products?page=${page}&size=${pageSize}`;
                const selectedCategory = categoryFilter.value;
                if (selectedCategory) {
                    url += `&category=${encodeURIComponent(selectedCategory)}`;
                }

                const res = await fetch(url);
                const data = await res.json();
                products = data.items;
                totalProducts = data.total;
                totalPages = Math.ceil(totalProducts / pageSize);
                renderProducts();
                updatePaginationControls();
            } catch (err) {
                console.error("‚ùå Failed to load products page:", err);
                alert("Error loading products");
            }
        }

        function showLoading() {
            document.getElementById('products-table-body').innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-gray-500">Loading...</td>
                </tr>`;
        }

        // ‚úÖ Initialize the application
        document.addEventListener('DOMContentLoaded', init);

        // ‚úÖ Update product category dropdown in product modal
        function updateProductCategorySelect(selectedValue = '') {
            productCategorySelect.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                if (category.name === selectedValue) {
                    option.selected = true;
                }
                productCategorySelect.appendChild(option);
            });
        }
        
        function updatePaginationControls() {
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;

            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        //Quote Admin Panel
        //////////////////////
        async function fetchQuotation() {
            const setText = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val || '';
            };

            const quotationNo = document.getElementById('quotation-no-select')?.value?.trim();
            const revision = document.getElementById('quotation-rev-select')?.value?.trim();

            if (!quotationNo) {
                return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤');
            }

            let url = `/quotation/${quotationNo}`;
            if (revision && revision !== 'latest') {
                url += `?rev=${revision}`;
            }

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ (${res.status})`);
                const data = await res.json();

                updateStatusUI(data.status || 'Pending');

                // ‚úÖ Map item + ‡πÄ‡∏ï‡∏¥‡∏° cost ‡∏à‡∏≤‡∏Å products ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô quotation
                cart = data.items.map(item => {
                    const match = products.find(p =>
                        p.product_id?.toString().trim() === (item.product_id || item.id)?.toString().trim()
                    );

                    return {
                        ...item,
                        id: item.product_id || item.id || '-',
                        flangeConfig: item.flangeConfig || item.flange || null,
                        cost: parseFloat(item.cost || 0)  // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å backend ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    };
                });

                if (data.customer) {
                    document.getElementById('customer-name').value = data.customer.name || '';
                    document.getElementById('customer-email').value = data.customer.email || '';
                    document.getElementById('customer-phone').value = data.customer.phone || '';
                    document.getElementById('customer-company').value = data.customer.company || '';
                    document.getElementById('customer-address').value = data.customer.address || '';
                    document.getElementById('customer-notes').value = data.customer.notes || '';
                    document.getElementById('sales-person').value = data.customer.sales_person || '';
                    document.getElementById('sales-mobile').value = data.customer.sales_mobile || '';
                    document.getElementById('sales-email').value = data.customer.sales_email || '';
                    document.getElementById('sales-contact').value = data.customer.sales_contact || '';
                    document.getElementById('contact-tel').value = data.customer.contact_tel || '';
                    document.getElementById('contact-email').value = data.customer.contact_email || '';
                    document.getElementById('delivery-time').value = data.customer.delivery_time || '';
                    document.getElementById('delivery-term').value = data.customer.delivery_term || '';
                    document.getElementById('payment-term').value = data.customer.payment_term || '';
                    document.getElementById('quotation-validity').value = data.customer.quotation_validity || '';

                    const customerRefEl = document.getElementById('customer-ref');
                    if (customerRefEl) customerRefEl.value = data.customer.customer_ref || '';

                    const enquiryRefEl = document.getElementById('enquiry-ref');
                    if (enquiryRefEl) enquiryRefEl.value = data.customer.enquiry_ref || '';
                }

                const quotationInput = document.getElementById('quotation-auto');
                if (quotationInput) {
                    quotationInput.value = revision
                        ? `${quotationNo} Rev. ${revision}`
                        : quotationNo;
                }

                const quoteNoEl = document.querySelector('.quotation .font-normal');
                if (quoteNoEl) {
                    quoteNoEl.textContent = revision
                        ? `${quotationNo} Rev. ${revision}`
                        : quotationNo;
                }

                const issued = data.issued_date;
                if (issued) {
                    setText('quote-date', issued);
                    setText('signature-date', issued);
                } else {
                    const fallback = new Date().toLocaleDateString('en-GB');
                    setText('quote-date', fallback);
                    setText('signature-date', fallback);
                }

                // ‚úÖ Update preview
                setText('quote-customer-name', data.customer.name);
                setText('quote-customer-email', data.customer.email);
                setText('quote-customer-phone', data.customer.phone);
                setText('quote-customer-company', data.customer.company);
                setText('quote-customer-address', data.customer.address);
                setText('quote-notes', data.customer.notes);
                setText('quote-sales-person', data.customer.sales_person);
                setText('quote-sales-mobile', data.customer.sales_mobile);
                setText('quote-sales-email', data.customer.sales_email);
                setText('quote-sales-contact', data.customer.sales_contact);
                setText('quote-contact-tel', data.customer.contact_tel);
                setText('quote-contact-email', data.customer.contact_email);
                setText('quote-delivery-time', data.customer.delivery_time);
                setText('quote-delivery-term', data.customer.delivery_term);
                setText('quote-payment-term', data.customer.payment_term);
                setText('quote-quotation-validity', data.customer.quotation_validity);
                setText('quote-customer-ref', data.customer.customer_ref);
                setText('quote-enquiry-ref', data.customer.enquiry_ref);

                renderQuotationItems(cart);

                lastSubmittedCustomerSnapshot = JSON.stringify({
                    name: data.customer.name,
                    email: data.customer.email,
                    phone: data.customer.phone,
                    company: data.customer.company,
                    address: data.customer.address,
                    notes: data.customer.notes,
                    sales_person: data.customer.sales_person,
                    sales_mobile: data.customer.sales_mobile,
                    sales_email: data.customer.sales_email,
                    sales_contact: data.customer.sales_contact,
                    contact_tel: data.customer.contact_tel,
                    contact_email: data.customer.contact_email,
                    delivery_time: data.customer.delivery_time,
                    delivery_term: data.customer.delivery_term,
                    payment_term: data.customer.payment_term,
                    quotation_validity: data.customer.quotation_validity,
                    customer_ref: data.customer.customer_ref,
                    enquiry_ref: data.customer.enquiry_ref
                });


                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î revision dropdown
                const revSelect = document.getElementById('quotation-rev-select');
                if (revSelect) {
                    revSelect.innerHTML = '<option value="latest">Latest</option>';

                    try {
                        const resRev = await fetch(`/revisions/${quotationNo}`);
                        if (!resRev.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î revision");

                        const revisions = await resRev.json(); // ‡πÄ‡∏ä‡πà‡∏ô [1, 2, 3]
                        if (Array.isArray(revisions)) {
                            revisions.forEach(rev => {
                                const option = document.createElement('option');
                                option.value = rev;
                                option.textContent = `Rev. ${rev}`;
                                revSelect.appendChild(option);
                            });
                        } else {
                            console.warn("‚ö†Ô∏è revisions ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array:", revisions);
                        }
                    } catch (e) {
                        console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î revision:", e.message);
                    }

                    revSelect.value = revision || 'latest';
                }

                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ dropdown
                const statusFilter = document.getElementById('quotation-status-filter');
                if (statusFilter) {
                    statusFilter.value = data.status || '';
                }

            } catch (err) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                console.error('‚ùå Error fetching quotation:', err);
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown
        async function loadQuotationDropdown() {
                const dropdown = document.getElementById('quotation-no-select');
                if (!dropdown) return;

                try {
                    const statusFilter = document.getElementById('quotation-status-filter')?.value || '';
                    let url = '/quotation_list';

                    if (statusFilter) {
                        url += `?status=${encodeURIComponent(statusFilter)}`;
                    }

                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Failed to load quotations');
                    const list = await res.json();

                    dropdown.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ --</option>';
                    list.forEach(qno => {
                        const option = document.createElement('option');
                        option.value = qno;
                        option.textContent = qno;
                        dropdown.appendChild(option);
                    });
                } catch (e) {
                    console.error('Error loading quotations:', e);
                }
        }

        async function renderQuotationItems() {
            const quoteItems = document.getElementById('quote-items');
            quoteItems.innerHTML = '';

            const customerNote = document.getElementById('customer-notes')?.value?.trim() || 'No additional notes.';
            const raw = document.getElementById('quotation-auto')?.value?.trim();

            let quotation_no = '';
            let rev = 0;

            if (raw) {
                if (raw.includes('Rev.')) {
                    const [qnoPart, revPart] = raw.split('Rev.');
                    quotation_no = qnoPart?.trim();
                    const revParsed = revPart?.trim();
                    rev = (!revParsed || isNaN(parseInt(revParsed))) ? 0 : parseInt(revParsed);
                } else {
                    quotation_no = raw.trim();
                    rev = 0;
                }
            }

            // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î drawing files
            drawingFiles = [];
            if (quotation_no) {
                try {
                    const revToSend = rev === 0 ? '' : rev;
                    const res = await fetch(`/drawing_files?quotation_no=${quotation_no}&rev=${revToSend}`);
                    drawingFiles = await res.json();

                    cart.forEach((item, index) => {
                        const rawDwg = item.dwg;
                        const dwgFromItem = (rawDwg || '')
                            .toLowerCase()
                            .replace(/\.(pdf|dwg)$/i, '')
                            .replace(/\s+/g, '_')
                            .replace(/[()]/g, '')
                            .trim();

                        const matched = drawingFiles.find(f => {
                            const dwgFromFile = (f.drawing_name || '')
                                .toLowerCase()
                                .replace(/\.(pdf|dwg)$/i, '')
                                .replace(/\s+/g, '_')
                                .replace(/[()]/g, '')
                                .trim();
                            return dwgFromItem && dwgFromItem === dwgFromFile;
                        });

                        if (matched) {
                            drawingSelections[index] = matched.drawing_url;
                        }
                    });
                } catch (err) {
                    console.error('‚ùå Failed to load drawing files:', err);
                }
            }

            let totalMargin = 0;

            cart.forEach((item, index) => {
                const price = parseFloat(item.price) || 0;
                const cost = parseFloat(item.cost) || 0;
                const qty = parseInt(item.quantity) || 1;
                const itemTotal = price * qty;
                const marginAmount = (price - cost) * qty;
                totalMargin += marginAmount;

                const isLast = index === cart.length - 1;
                const model = item.product_id || item.id || '-';

                const selectedUrl = drawingSelections[index];
                const selectedName = drawingFiles.find(f => f.drawing_url === selectedUrl)?.drawing_name || '';

                const noteBlock = isLast ? `
                    <br>******************************************<br>
                    <strong style="font-size:10px;">NOTE :</strong><br>
                    <span style="font-size:10px;">
                    ${customerNote.replace(/\n/g, '<br>')}
                    </span>
                ` : '';

                const descWithLength = (() => {
                    const desc = item.description || '';
                    const length = item.length;
                    let finalDesc = desc;

                    if (/L\s*=\s*$/.test(desc) && length) {
                        finalDesc = desc + `${length}mm`;
                    } else if (!/L\s*=/.test(desc) && length) {
                        finalDesc = desc + `, L=${length}mm`;
                    }

                    return finalDesc;
                })();

                const dwgDropdown = drawingFiles.length > 0 ? `
                    <div class="text-xs mt-1">
                        Dwg:
                        <select class="px-1 py-1 text-xs rounded ml-2" onchange="handleDrawingChange(${index}, this.value)">
                            <option value="">-- Select Drawing --</option>
                            ${drawingFiles.map(f => `
                                <option value="${f.drawing_url}" ${f.drawing_url === selectedUrl ? 'selected' : ''}>
                                    ${f.drawing_name.replace(/\.(pdf|dwg)$/i, '')}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                ` : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-2 py-1 align-top">${index + 1}</td>
                    <td class="px-2 py-1 align-top">${model}</td>
                    <td class="px-2 py-1 align-top">
                        ${descWithLength}
                        ${dwgDropdown}
                        ${noteBlock}
                    </td>
                    <td class="px-2 py-1 text-center align-top">${qty}</td>
                    <td class="px-2 py-1 text-center align-top">PCS</td>
                    <td class="px-2 py-1 text-right align-top">${price.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td class="px-2 py-1 text-right align-top">${itemTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td class="px-2 py-1 text-right align-top">${cost.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td class="px-2 py-1 text-right align-top">${marginAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                `;
                quoteItems.appendChild(row);
            });

            const subtotal = cart.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1)), 0);
            const tax = subtotal * 0.07;
            const total = subtotal + tax;

            document.getElementById('quote-subtotal').textContent = subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
            document.getElementById('quote-tax').textContent = tax.toLocaleString(undefined, { minimumFractionDigits: 2 });
            document.getElementById('quote-total').textContent = total.toLocaleString(undefined, { minimumFractionDigits: 2 });

            if (document.getElementById('quote-total-words')) {
                document.getElementById('quote-total-words').textContent = numberToWordsBaht(total);
            }

            // ‚úÖ Total Margin
            if (document.getElementById('quote-margin')) {
                const marginPercent = subtotal > 0 ? (totalMargin / subtotal) * 100 : 0;
                const formattedMargin = totalMargin.toLocaleString(undefined, { minimumFractionDigits: 2 });
                const formattedPercent = `(${Math.round(marginPercent)}%)`;
                document.getElementById('quote-margin').textContent = `${formattedMargin} ${formattedPercent}`;
            }
        }

        function handleDrawingChange(index, value) {
            if (!drawingSelections) drawingSelections = [];
            if (!cart || !cart[index]) return;

            drawingSelections[index] = value;
            cart[index].dwg = value;
        }

        function numberToWordsBaht(num) {
            const a = [
                '', 'one', 'two', 'three', 'four', 'five',
                'six', 'seven', 'eight', 'nine', 'ten', 'eleven',
                'twelve', 'thirteen', 'fourteen', 'fifteen',
                'sixteen', 'seventeen', 'eighteen', 'nineteen'
            ];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty',
                'sixty', 'seventy', 'eighty', 'ninety'];

            const units = [
                '', ' thousand', ' million', ' billion', ' trillion',
                ' quadrillion', ' quintillion', ' sextillion', ' septillion'
            ];

            const chunkToWords = (n) => {
                if (n === 0) return '';
                if (n < 20) return a[n];
                if (n < 100) return b[Math.floor(n / 10)] + (n % 10 ? '-' + a[n % 10] : '');
                if (n < 1000) return a[Math.floor(n / 100)] + ' hundred' + (n % 100 ? ' ' + chunkToWords(n % 100) : '');
                return '';
            };

            const numToWords = (num) => {
                if (num === 0) return 'zero';
                const chunks = [];
                while (num > 0) {
                chunks.push(num % 1000);
                num = Math.floor(num / 1000);
                }
                return chunks
                .map((chunk, i) => chunk ? chunkToWords(chunk) + units[i] : '')
                .reverse()
                .join(' ')
                .trim();
            };

            const parts = num.toFixed(2).split('.');
            const baht = parseInt(parts[0], 10);
            const satang = parseInt(parts[1], 10);

            const bahtWords = numToWords(baht).toUpperCase();

            if (satang === 0) {
                return `(${bahtWords} BAHT ONLY)`;
            } else {
                return `(${bahtWords} BAHT AND ${parts[1]}/100)`;
            }
        }

        function updateQuotationStatus(newStatus) {
            const quotationNo = document.getElementById('quotation-no-select')?.value?.trim();
            let rev = document.getElementById('quotation-rev-select')?.value?.trim();

            if (!quotationNo) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤');
                return;
            }

            // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ Rev. ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô "Latest"
            if (!rev || rev === 'latest') {
                rev = '';  // ‡πÉ‡∏ä‡πâ rev ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏£‡∏Å (Rev.0)
            }

            fetch('/update_quotation_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quotation_no: quotationNo,
                    rev,
                    status: newStatus
                })
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to update status');
                return res.json();
            })
            .then(data => {
                alert(`Updated to "${newStatus}" successfully.`);
                loadQuotationDropdown(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä dropdown
            })
            .catch(err => {
                console.error(err);
                alert('Error updating quotation status');
            });
        }

        // üéØ Add event listeners to buttons
        document.getElementById('pending-btn')?.addEventListener('click', () => updateQuotationStatus('Pending'));
        document.getElementById('approve-btn')?.addEventListener('click', () => updateQuotationStatus('Approve'));
        document.getElementById('disapprove-btn')?.addEventListener('click', () => updateQuotationStatus('Disapprove'));

        document.getElementById('edit-quote')?.addEventListener('click', () => {
            showView('customer');

            const genBtn = document.getElementById('generate-quotation-btn');  // ‚úÖ id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á
            if (genBtn) {
                genBtn.textContent = 'Generate Quotation (Revision)';
                genBtn.setAttribute('data-revision-mode', 'true'); // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            }

            document.getElementById('back-to-cart')?.classList.add('hidden');
        });

        function getCustomerFormData() {
            return {
                name: document.getElementById('customer-name')?.value.trim() || '',
                email: document.getElementById('customer-email')?.value.trim() || '',
                phone: document.getElementById('customer-phone')?.value.trim() || '',
                company: document.getElementById('customer-company')?.value.trim() || '',
                address: document.getElementById('customer-address')?.value.trim() || '',
                notes: document.getElementById('customer-notes')?.value.trim() || '',
                sales_person: document.getElementById('sales-person')?.value.trim() || '',
                sales_mobile: document.getElementById('sales-mobile')?.value.trim() || '',
                sales_email: document.getElementById('sales-email')?.value.trim() || '',
                sales_contact: document.getElementById('sales-contact')?.value.trim() || '',
                contact_tel: document.getElementById('contact-tel')?.value.trim() || '',
                contact_email: document.getElementById('contact-email')?.value.trim() || '',
                delivery_time: document.getElementById('delivery-time')?.value.trim() || '',
                delivery_term: document.getElementById('delivery-term')?.value.trim() || '',
                payment_term: document.getElementById('payment-term')?.value.trim() || '',
                quotation_validity: document.getElementById('quotation-validity')?.value.trim() || '',
                customer_ref: document.getElementById('customer-ref')?.value.trim() || '',
                enquiry_ref: document.getElementById('enquiry-ref')?.value.trim() || ''
            };
        }

        let lastSubmittedCustomerSnapshot = '';
        async function generateAndSendQuotation() {
            const generateBtn = document.getElementById('generate-quotation-btn'); 
            const getValue = id => document.getElementById(id)?.value?.trim() || '';
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            // Customer info
            const customerName = getValue('customer-name');
            const customerEmail = getValue('customer-email');
            if (!customerName || !customerEmail) {
                alert('Please fill in required fields (Name and Email)');
                return;
            }
            if (!cart.length) {
                alert('Cart is empty');
                return;
            }

            const currentCustomer = normalizeCustomerData(getCustomerFormData());
            const currentCustomerSnapshot = JSON.stringify(currentCustomer);

            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            const customerChanged = currentCustomerSnapshot !== lastSubmittedCustomerSnapshot;

            if (!customerChanged) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà');
                return;
            }

            const customerCompany = getValue('customer-company');
            const customerPhone = getValue('customer-phone');
            const customerAddress = getValue('customer-address');
            const customerNotes = getValue('customer-notes');
            const customerRef = getValue('customer-ref');
            const enquiryRef = getValue('enquiry-ref');

            // Sales info
            const salesPerson = getValue('sales-person');
            const salesMobile = getValue('sales-mobile');
            const salesEmail = getValue('sales-email');
            const salesContact = getValue('sales-contact');
            const contactTel = getValue('contact-tel');
            const contactEmail = getValue('contact-email');

            // Delivery / Payment / Validity
            const deliveryTime = getValue('delivery-time');
            const deliveryTerm = getValue('delivery-term');
            const paymentTerm = getValue('payment-term');
            const quotationValidity = getValue('quotation-validity');

            let quotationNo = getValue('quotation-auto').split(' Rev.')[0] || 'QT2408T-0001';

            // Update UI preview (before sending)
            const today = new Date().toLocaleDateString('en-GB');
            setText('quote-date', today);
            setText('signature-date', today);
            setText('quote-customer-name', customerName);
            setText('quote-customer-email', customerEmail);
            setText('quote-customer-phone', customerPhone);
            setText('quote-customer-company', customerCompany);
            setText('quote-customer-ref', customerRef);
            setText('quote-enquiry-ref', enquiryRef);
            setText('quote-customer-address', customerAddress);
            setText('quote-notes', customerNotes || 'No additional notes.');
            setText('quote-sales-person', salesPerson);
            setText('quote-sales-mobile', salesMobile);
            setText('quote-sales-email', salesEmail);
            setText('quote-sales-contact', salesContact);
            setText('quote-contact-tel', contactTel);
            setText('quote-contact-email', contactEmail);
            setText('quote-delivery-time', deliveryTime);
            setText('quote-delivery-term', deliveryTerm);
            setText('quote-payment-term', paymentTerm);
            setText('quote-quotation-validity', quotationValidity);

            renderQuotationItems(cart);

            document.getElementById('generate-quotation-btn')?.addEventListener('click', generateAndSendQuotation);
            if (generateBtn) generateBtn.disabled = true;

            try {
                const sanitizedItems = cart.map(item => {
                    const desc = item.description || '';
                    const length = item.length;
                    let finalDesc = desc;

                    if (/L\s*=\s*$/.test(desc) && length) {
                        finalDesc = desc + `${length}mm`;
                    } else if (!/L\s*=/.test(desc) && length) {
                        finalDesc = desc + `, L=${length}mm`;
                    }

                    return {  
                        product_id: String(item.product_id || item.id || '-'),
                        name: String(item.name || ''),
                        description: finalDesc,
                        category: String(item.category || 'uncategorized'),
                        price: parseFloat(item.price || 0),
                        quantity: parseInt(item.quantity) || 1,
                        length: parseFloat(item.length || 0),
                        volume: parseFloat(item.volume || 0),
                        cost: parseFloat(item.cost || 0)
                    };
                });

                const payload = {
                    quotation_no: quotationNo,
                    customer_name: customerName,
                    email: customerEmail,
                    phone: customerPhone,
                    company: customerCompany,
                    address: customerAddress,
                    notes: customerNotes,
                    sales_person: salesPerson,
                    sales_mobile: salesMobile,
                    sales_email: salesEmail,
                    sales_contact: salesContact,
                    contact_tel: contactTel,
                    contact_email: contactEmail,
                    delivery_time: deliveryTime,
                    delivery_term: deliveryTerm,
                    payment_term: paymentTerm,
                    quotation_validity: quotationValidity,
                    customer_ref: customerRef,
                    enquiry_ref: enquiryRef,
                    items: sanitizedItems
                };

                const res = await fetch("/add_quotation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`Failed to submit quotation.\n${errText}`);
                }

                const data = await res.json();



                const quoteNoElement = document.querySelector('.quotation .font-normal');
                if (data.quotation_no && quoteNoElement) {
                    quoteNoElement.textContent = data.rev > 0
                        ? `${data.quotation_no} Rev. ${data.rev}`
                        : data.quotation_no;
                }

                const quotationInput = document.getElementById('quotation-auto');
                if (quotationInput) {
                    quotationInput.value = data.rev > 0
                        ? `${data.quotation_no} Rev. ${data.rev}`
                        : data.quotation_no;
                }

                if (data.status === "skipped") {
                    alert(`Duplicate quotation. Skipped saving. Quotation No: ${data.quotation_no}`);
                    lastSubmittedCustomerSnapshot = currentCustomerSnapshot;
                } else if (data.status === "success") {
                    alert("Quotation saved successfully to Google Sheet.");
                    lastSubmittedCustomerSnapshot = currentCustomerSnapshot;
                }

                lastSubmittedCustomerSnapshot = currentCustomerSnapshot;

                if (typeof loadQuotationDropdown === 'function') {
                    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Quotation View
                    await loadQuotationDropdown();

                    const revVal = data.rev > 0 ? String(data.rev) : 'latest';
                    document.getElementById('quotation-no-select').value = data.quotation_no;
                    document.getElementById('quotation-rev-select').value = revVal;

                    // üîÅ ‡πÄ‡∏û‡∏¥‡πà‡∏° option ‡πÄ‡∏Ç‡πâ‡∏≤ dropdown ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏Å‡πà‡∏≠‡∏ô set value)
                    const quotationSelect = document.getElementById('quotation-no-select');
                    const revSelect = document.getElementById('quotation-rev-select');

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ option ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                    if (![...quotationSelect.options].some(opt => opt.value === data.quotation_no)) {
                        const opt = document.createElement('option');
                        opt.value = data.quotation_no;
                        opt.textContent = data.quotation_no;
                        quotationSelect.appendChild(opt);
                    }

                    if (![...revSelect.options].some(opt => opt.value === String(data.rev))) {
                        const opt = document.createElement('option');
                        opt.value = String(data.rev);
                        opt.textContent = `Rev. ${data.rev}`;
                        revSelect.appendChild(opt);
                    }

                    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡πà‡∏≤ dropdown ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å option ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
                    quotationSelect.value = data.quotation_no;
                    revSelect.value = String(data.rev);

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ quotation + ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    showView('quotation');
                    await fetchQuotation(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á

                    // ‚úÖ Reset ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
                    const genBtn = document.getElementById('generate-quotation-btn');
                    if (genBtn) {
                        genBtn.textContent = 'Generate Quotation';
                        genBtn.removeAttribute('data-revision-mode');
                    }
                }

            } catch (err) {
                console.error("‚ùå Error saving quotation:", err);
                alert("Error saving quotation. Please check the data and try again.");
            } finally {
                if (generateBtn) generateBtn.disabled = false;
            }
        }

        async function generateQuotationNo() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);  // '25'
            const month = String(now.getMonth() + 1).padStart(2, '0');  // '07'
            const prefix = `QT${year}${month}T-`;

            try {
                // üîç ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ prefix ‡∏ô‡∏µ‡πâ
                const res = await fetch(`/latest_quotation_no?prefix=${prefix}`);
                if (!res.ok) throw new Error("Failed to fetch latest quotation number");
                const data = await res.json();

                const last = data.last || '';
                let nextNumber = 1;

                if (last.startsWith(prefix)) {
                    const lastDigits = parseInt(last.slice(prefix.length));
                    if (!isNaN(lastDigits)) nextNumber = lastDigits + 1;
                }

                const newQuotationNo = `${prefix}${String(nextNumber).padStart(4, '0')}`;

                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Quotation No (‡πÑ‡∏°‡πà‡∏°‡∏µ Rev.)
                const quotationInput = document.getElementById('quotation-auto');
                if (quotationInput) {
                    quotationInput.value = newQuotationNo;
                }

            } catch (err) {
                console.error("‚ùå Error generating quotation no:", err);
                alert("Cannot auto-generate quotation number");
            }
        }

        function normalizeCustomerData(customer) {
            return {
                name: customer.name || '',
                email: customer.email || '',
                phone: customer.phone || '',
                company: customer.company || '',
                address: customer.address || '',
                notes: customer.notes || '',
                sales_person: customer.sales_person || '',
                sales_mobile: customer.sales_mobile || '',
                sales_email: customer.sales_email || '',
                sales_contact: customer.sales_contact || '',
                contact_tel: customer.contact_tel || '',
                contact_email: customer.contact_email || '',
                delivery_time: customer.delivery_time || '',
                delivery_term: customer.delivery_term || '',
                payment_term: customer.payment_term || '',
                quotation_validity: customer.quotation_validity || '',
                customer_ref: customer.customer_ref || '',
                enquiry_ref: customer.enquiry_ref || ''
            };
        }

        function updateStatusUI(status) {
            const approveBtn = document.getElementById('approve-btn');
            const disapproveBtn = document.getElementById('disapprove-btn');

            if (status === 'Pending') {
                // ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°
                approveBtn.disabled = false;
                disapproveBtn.disabled = false;
                approveBtn.classList.remove('bg-gray-400');
                disapproveBtn.classList.remove('bg-gray-400');
                approveBtn.classList.add('bg-green-500');
                disapproveBtn.classList.add('bg-red-500');
            } else if (status === 'Approve') {
                approveBtn.disabled = true;
                disapproveBtn.disabled = true;
                approveBtn.classList.remove('bg-green-500');
                approveBtn.classList.add('bg-gray-400');
                disapproveBtn.classList.remove('bg-red-500');
                disapproveBtn.classList.add('bg-gray-400');
            } else if (status === 'Disapprove') {
                approveBtn.disabled = false;
                disapproveBtn.disabled = true;
                approveBtn.classList.remove('bg-gray-400');
                approveBtn.classList.add('bg-green-500');
                disapproveBtn.classList.remove('bg-red-500');
                disapproveBtn.classList.add('bg-gray-400');
            }
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å quotation ‡πÅ‡∏•‡πâ‡∏ß:
        updateStatusUI('Pending');  // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å backend

        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        document.getElementById('approve-btn')?.addEventListener('click', () => {
            updateStatusUI('Approve');
            // üëâ ‡∏™‡πà‡∏á status ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ backend ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        });

        document.getElementById('disapprove-btn')?.addEventListener('click', () => {
            updateStatusUI('Disapprove');
            // üëâ ‡∏™‡πà‡∏á status ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ backend ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        });

        document.getElementById('uploadPdfBtn')?.addEventListener('click', async () => {
            const input = document.getElementById('drawingPdfInput');
            const files = input?.files;
            if (!files || files.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠ DWG ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
                return;
            }

            const raw = document.getElementById('quotation-auto')?.value?.trim();
            if (!raw) {
                return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤');
            }

            // üëâ ‡πÅ‡∏¢‡∏Å quotation_no ‡πÅ‡∏•‡∏∞ rev (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ Rev.)
            let quotation_no = '';
            let rev = '';

            if (raw.includes('Rev.')) {
                const [qno, revPart] = raw.split('Rev.');
                quotation_no = qno.trim();
                const revParsed = revPart?.trim();
                rev = (revParsed === '' || isNaN(parseInt(revParsed))) ? 0 : parseInt(revParsed);
            } else {
                quotation_no = raw.trim();
                rev = 0;
            }

            // ‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° FormData
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }

            // ‚úÖ ‡∏™‡πà‡∏á rev = '' ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô rev 0 (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï)
            const revToSend = rev === 0 ? '' : rev;

            formData.append('quotation_no', quotation_no);
            formData.append('rev', revToSend);

            try {
                const res = await fetch('/upload_drawing', {
                    method: 'POST',
                    body: formData
                });

                const result = await res.json();
                if (res.ok) {
                    alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
                    input.value = '';

                    // ‡πÇ‡∏´‡∏•‡∏î drawings ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ
                    const drawingFiles = await fetch(`/drawing_files?quotation_no=${quotation_no}&rev=${revToSend}`)
                        .then(r => r.json());

                    renderQuotationItems(drawingFiles);
                } else {
                    alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.message || 'unknown error'}`);
                }
            } catch (err) {
                console.error('‚ùå upload error:', err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
            }
        });

        document.getElementById('upload-excel-btn')?.addEventListener('click', async () => {
            const input = document.getElementById('excel-upload');
            const file = input?.files?.[0];
            if (!file) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload_excel', {
                method: 'POST',
                body: formData
                });
                const result = await res.json();
                if (res.ok) {
                alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
                input.value = '';
                } else {
                alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
                }
            } catch (err) {
                console.error(err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
            }
        });

    </script>
</body>
</html>


